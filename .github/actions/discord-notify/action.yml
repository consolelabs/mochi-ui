name: Discord release notify

inputs:
  github-token:
    description: 'Token to access the github'
    required: true
  discord-webhook:
    description: 'The Discord webhook URL'
    required: true
  # Data JSON format: [{ name: "package-1", version: 1.0.0, tag_name: "package-1@1.0.0", ignore_npm_released: false }, ...]
  tags-info:
    description: 'JSON array of name, version, tag_name and ignore_npm_released of released tags'
    required: true
  repo:
    description: 'The owner and repository name'
    required: true
  server-url:
    description: 'The URL of the GitHub server'
    required: true

runs:
  using: "composite"
  steps:
    - name: Get current time
      uses: josStorer/get-current-time@v2
      id: current-time
      with:
        format: MMMM Do YYYY, h:mm a
        utcOffset: '+07:00'

    - name: Get Discord Content
      id: discord-content
      uses: actions/github-script@v7
      with:
        script: |
          const breakLine = "\n";
          const tagsInfo = Array.from(${{ fromJson(inputs.tags-info) }})
          const npmURLtemplate = "https://www.npmjs.com/package/{name}/v/{version}"
          const footer = "*Released at ${{ steps.current-time.outputs.formattedTime }}*";
          const contentInfo = tagsInfo
            .map((tag) => {
              const name = tag.name;
              const version = tag.version;
              const tagName = tag.tag_name;

              const githubTagName = tagName || `${name}@${version}`

              const npmLink = npmURLtemplate.replace("{name}", name).replace("{version}", version)
              const githubURL = `${{ inputs.server-url }}/${{ inputs.repo }}/releases/tag/${encodeURIComponent(githubTagName)}`

              const isIgnoreNPMReleased = tag.ignore_npm_released
              const packageName = isIgnoreNPMReleased ? `**${name}**` : `[**${name}**](${npmLink})`

              return `- ${packageName} was released to version: [**${version}**](${githubURL})`;
            })
            .join(breakLine);
          const info = [contentInfo, breakLine, footer].join("");
          return [
            {
              title: "New releases! ðŸš€ðŸš€ðŸš€",
              description: `${info}`,
              color: 1127128,
            },
          ];

    - name: Discord notification
      uses: Ilshidur/action-discord@master
      env:
        DISCORD_WEBHOOK: ${{ inputs.discord-webhook }}
        DISCORD_USERNAME: Github Release
        DISCORD_AVATAR: https://cdn.discordapp.com/avatars/1176117154010120202/df91181b3f1cf0ef1592fbe18e0962d7.webp?size=80
        DISCORD_EMBEDS: ${{ steps.discord-content.outputs.result }}
